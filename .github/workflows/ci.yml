# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT license.

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

env:
  RUSTFLAGS: -Dwarnings
  RUST_BACKTRACE: 1
  # Use the Rust version specified in rust-toolchain.toml
  rust_stable: "1.90"

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  # Basic checks that must pass before we kick off more expensive tests.
  basics:
    name: basic checks
    runs-on: ubuntu-latest
    needs:
      - clippy
      - fmt
      # TODO: Re-enable docs check later
      # - docs
    steps:
      - run: exit 0

  fmt:
    name: format check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust ${{ env.rust_stable }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.rust_stable }}
          components: rustfmt
      - uses: Swatinem/rust-cache@v2
      # Check fmt
      - name: "cargo fmt --check"
        run: |
          if ! cargo fmt --all --check; then
            printf "Please run \`cargo fmt --all\` to fix rustfmt errors.\n" >&2
            exit 1
          fi

  clippy:
    name: clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust ${{ env.rust_stable }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.rust_stable }}
          components: clippy
      - uses: Swatinem/rust-cache@v2
      # Run clippy on workspace
      - name: "clippy --workspace --all-targets"
        run: cargo clippy --workspace --all-targets --no-deps

  # TODO: Re-enable docs check later
  # docs:
  #   name: docs
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Install Rust ${{ env.rust_stable }}
  #       uses: dtolnay/rust-toolchain@stable
  #       with:
  #         toolchain: ${{ env.rust_stable }}
  #     - uses: Swatinem/rust-cache@v2
  #     - name: "doc --workspace --no-deps"
  #       run: cargo doc --workspace --no-deps --document-private-items
  #       env:
  #         RUSTDOCFLAGS: -Dwarnings

  test-workspace:
    needs: basics
    name: test workspace
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - windows-latest
          - ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust ${{ env.rust_stable }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.rust_stable }}

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - uses: Swatinem/rust-cache@v2

      - name: test workspace with nextest
        run: |
          set -euxo pipefail
          cargo nextest run --workspace --cargo-profile ci
          cargo test --doc --workspace --profile ci

  test-workspace-features:
    needs: basics
    name: test workspace
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os:
          - windows-latest
          - ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust ${{ env.rust_stable }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ env.rust_stable }}

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - uses: Swatinem/rust-cache@v2

      - name: test workspace with nextest
        run: |
          set -euxo pipefail
          cargo nextest run --workspace --cargo-profile ci \
            --features \
              virtual_storage,bf_tree,spherical-quantization,product-quantization,tracing,experimental_diversity_search

          cargo test --doc --workspace --profile ci

  # coverage:
  #   needs: basics
  #   name: code coverage
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         lfs: true

  #     - name: Install Rust ${{ env.rust_stable }}
  #       uses: dtolnay/rust-toolchain@stable
  #       with:
  #         toolchain: ${{ env.rust_stable }}
  #         components: llvm-tools-preview

  #     - name: Install cargo-llvm-cov
  #       uses: taiki-e/install-action@v2
  #       with:
  #         tool: cargo-llvm-cov

  #     - name: Install cargo-nextest
  #       uses: taiki-e/install-action@v2
  #       with:
  #         tool: cargo-nextest

  #     - uses: Swatinem/rust-cache@v2
  #     - name: Generate code coverage
  #       run: |
  #         cargo llvm-cov nextest --cargo-profile ci \
  #           --package diskann-wide \
  #           --package diskann-vector \
  #           --package diskann-quantization \
  #           --package diskann \
  #           --package diskann-linalg \
  #           --package diskann-utils \
  #           --package diskann-disk \
  #           --lcov --output-path lcov.info

  #     - name: Upload coverage to Codecov
  #       uses: codecov/codecov-action@v4
  #       with:
  #         files: lcov.info
  #         fail_ci_if_error: false
  #       env:
  #         CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  miri:
    needs: basics
    name: miri-test
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true

      - name: Install Rust nightly with miri
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: nightly
          components: miri

      - name: Install cargo-nextest
        uses: taiki-e/install-action@v2
        with:
          tool: cargo-nextest

      - uses: Swatinem/rust-cache@v2

      - name: miri
        run: |
          set -ux
          echo "::group::Miri Test Execution"
          START_TIME=$(date +%s)
          cargo +nightly miri nextest run --package diskann-quantization || true
          END_TIME=$(date +%s)
          DURATION=$((END_TIME - START_TIME))
          echo "::endgroup::"
          echo "::notice::Miri tests completed in ${DURATION} seconds"
        env:
          MIRIFLAGS: -Zmiri-disable-isolation -Zmiri-strict-provenance
