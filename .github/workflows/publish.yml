# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT license.

# Publishes all workspace crates to crates.io.
# Triggered by pushing a version tag (v{major}.{minor}.{patch}) or manually via workflow_dispatch.
# Requires CRATES_IO_TOKEN secret. Rust toolchain version is read from rust-toolchain.toml.

name: Publish to crates.io

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (test without actually publishing)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  RUST_BACKTRACE: 1

defaults:
  run:
    shell: bash

permissions:
  contents: read

jobs:
  publish:
    name: ${{ github.event.inputs.dry_run == 'true' && 'Dry-run publish test' || 'Publish crates to crates.io' }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Read Rust version from rust-toolchain.toml
        id: rust-version
        run: |
          RUST_VERSION=$(sed -n 's/^channel = "\(.*\)"/\1/p' rust-toolchain.toml)
          echo "channel=$RUST_VERSION" >> "$GITHUB_OUTPUT"

      - name: Install Rust ${{ steps.rust-version.outputs.channel }}
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: ${{ steps.rust-version.outputs.channel }}

      - uses: Swatinem/rust-cache@v2

      - name: Verify version matches tag
        if: github.event_name == 'push'
        run: |
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          CARGO_VERSION=$(grep '^version = ' Cargo.toml | head -n1 | sed 's/.*"\(.*\)".*/\1/')
          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "::error::Tag version ($TAG_VERSION) does not match Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi

      - name: Run tests
        run: cargo test --locked --workspace --profile ci

      - name: Publish workspace crates
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_IO_TOKEN }}
        run: |
          DRY_RUN_FLAG=""
          if [ "${{ github.event.inputs.dry_run || 'false' }}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
            echo "ðŸ§ª DRY-RUN MODE"
          fi
          cargo publish --locked --workspace $DRY_RUN_FLAG
