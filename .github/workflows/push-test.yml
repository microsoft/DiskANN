name: DiskANN Build
on: [push]
jobs:
  ubuntu-latest-build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
    - name: Install deps
      run: |
        sudo apt install cmake g++ libaio-dev libgoogle-perftools-dev libunwind-dev clang-format libboost-dev libboost-program-options-dev libmkl-full-dev
    - name: Clang Format Check
      run: |
        mkdir build && cd build && cmake -DRESTAPI=True -DCMAKE_BUILD_TYPE=Release ..
        make checkformat
    - name: build
      run: |
        cd build && make -j

    - name: Set up Python
      uses: actions/setup-python@v3
      with:
        python-version: "3.10"
    - name: Install dependencies
      run: |
        pip install -r tests/python/requirements.txt
    - name: Run REST Integration Tests
      run: |
        export DISKANN_BUILD_DIR=`pwd`/build
        cd tests/python
        python -m unittest
  windows-build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [windows-2019, windows-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
          submodules: true

    - name: Add VisualStudio command line tools into path
      uses: ilammy/msvc-dev-cmd@v1

    - name: Run configure and build
      run: |
        mkdir build && cd build && cmake .. && msbuild diskann.sln /m /nologo /t:Build /p:Configuration="Release" /property:Platform="x64" -consoleloggerparameters:"ErrorsOnly;Summary"
      shell: cmd
